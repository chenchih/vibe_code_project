<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤å‹è»Ÿé«”å¤§é ­ç…§è©•åˆ†å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ç¢ºä¿åœ¨é‹è¡Œç’°å¢ƒä¸­å®šç¾©äº†é€™äº›è®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dating-app-evaluator';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            setLogLevel('debug'); // å•Ÿç”¨ Firebase åµéŒ¯æ—¥èªŒ

            // è™•ç†èªè­‰
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Firebase signed in with custom token.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Firebase signed in anonymously.");
                    }
                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            })();
        } else {
            console.warn("Firebase configuration not found. Using anonymous session.");
            window.userId = crypto.randomUUID();
        }
    </script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .score-display {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
        }
        .score-display.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .photo-slot {
            aspect-ratio: 1 / 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">
            ğŸ“¸ äº¤å‹è»Ÿé«”å¤§é ­ç…§è©•åˆ†å™¨ (AIæ¨¡æ“¬)
        </h1>
        
        <!-- æ€§åˆ¥é¸æ“‡ -->
        <div class="mb-8">
            <label class="block text-lg font-medium text-gray-700 mb-3">
                é¸æ“‡æ‚¨çš„èº«ä»½ï¼š
            </label>
            <div class="flex space-x-4">
                <button id="select-female" class="gender-select px-6 py-3 rounded-full text-white bg-pink-500 hover:bg-pink-600 transition shadow-lg shadow-pink-200" data-gender="Female">
                    ğŸ‘© å¥³ç”Ÿ (Female)
                </button>
                <button id="select-male" class="gender-select px-6 py-3 rounded-full text-white bg-blue-500 hover:bg-blue-600 transition shadow-lg shadow-blue-200" data-gender="Male">
                    ğŸ‘¨ ç”·ç”Ÿ (Male)
                </button>
            </div>
            <p id="gender-status" class="mt-2 text-sm font-semibold text-red-500">è«‹å…ˆé¸æ“‡èº«ä»½</p>
        </div>

        <!-- ç…§ç‰‡ä¸Šå‚³å€ -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ä¸Šå‚³ç…§ç‰‡ (æœ€å¤š 6 å¼µ)ï¼š</h2>
            <div id="photo-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- 6 å€‹ç…§ç‰‡ä¸Šå‚³æ§½ -->
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-10">
            <button id="start-button" class="flex-1 px-8 py-4 rounded-xl text-white font-bold bg-green-500 hover:bg-green-600 transition duration-150 shadow-xl shadow-green-300 disabled:bg-gray-400" disabled>
                ğŸš€ é–‹å§‹ AI è©•åˆ†
            </button>
            <button id="clear-button" class="flex-1 px-8 py-4 rounded-xl text-gray-700 font-bold bg-gray-200 hover:bg-gray-300 transition duration-150 shadow-md disabled:opacity-50">
                ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç…§ç‰‡
            </button>
        </div>
        
        <!-- è¼‰å…¥åŠè¨Šæ¯é¡¯ç¤º -->
        <div id="message-area" class="min-h-16 flex items-center justify-center mb-6">
            <div id="loading-indicator" class="hidden flex items-center space-x-3 text-lg font-medium text-indigo-600">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                æ­£åœ¨è«‹ AI å°ˆå®¶è©•ä¼°ä¸­ï¼Œè«‹ç¨å€™...
            </div>
            <p id="error-message" class="text-red-500 hidden"></p>
        </div>

        <!-- ç¸½é«”è©•åˆ†çµæœ -->
        <div id="overall-result" class="score-display p-6 bg-indigo-50 rounded-2xl border-2 border-indigo-200 mt-8">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                âœ¨ äº¤å‹å¸‚å ´æ•´é«”è¡¨ç¾ï¼š<span id="overall-score-value" class="ml-3 text-4xl text-indigo-600">--</span>/100
            </h2>
            
            <!-- ä¿®æ”¹ AI ç¶œåˆå»ºè­°å€å¡Šçš„æ ¼å¼ï¼Œä½¿å…¶æ›´å°ˆæ¥­ -->
            <div class="border-t pt-4 mt-4">
                <p class="text-xl font-bold text-gray-700 mb-2">AI ç¶œåˆå»ºè­°:</p>
                <!-- å»ºè­°å…§å®¹ä½¿ç”¨ç¨ç«‹å€å¡Šï¼Œç¢ºä¿æ›è¡Œå’Œå°ˆæ¥­æ„Ÿ -->
                <p id="overall-feedback" class="text-gray-800 leading-relaxed bg-white p-3 rounded-lg border italic">å°šç„¡è©•ä¼°çµæœã€‚</p>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; // Canvas å°‡åœ¨åŸ·è¡Œæ™‚æä¾›é‡‘é‘°

        let selectedGender = null;
        const maxPhotos = 6;
        const photoData = new Array(maxPhotos).fill(null); // å­˜å„² base64 æ•¸æ“š

        const app = document.getElementById('app');
        const photoContainer = document.getElementById('photo-container');
        const startButton = document.getElementById('start-button');
        const clearButton = document.getElementById('clear-button');
        const overallResult = document.getElementById('overall-result');
        const genderStatus = document.getElementById('gender-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');

        // --- New Keyword Highlighting Function ---
        function highlightKeywords(text) {
            if (!text) return 'å°šç„¡è©•ä¼°çµæœã€‚';

            // æ ¹æ“šä½¿ç”¨è€…æŒ‡ç¤ºæ›´æ–°é—œéµå­—åŠå…¶é¡è‰²æ¨£å¼
            const keywords = [
                // è¡Œå‹•å»ºè­° (è—è‰²) - åŒ…å« å»ºè­°, å¤šæ¨£æ€§, è‚¢é«”èªè¨€, æ”¹å–„, èª¿æ•´
                { word: 'å»ºè­°', color: 'text-blue-600' },
                { word: 'å¤šæ¨£æ€§', color: 'text-blue-600' },
                { word: 'è‚¢é«”èªè¨€', color: 'text-blue-600' },
                { word: 'æ”¹å–„', color: 'text-blue-600' },
                { word: 'èª¿æ•´', color: 'text-blue-600' },
                
                // Positive/Good (ç¶ è‰²) - åŒ…å« é™½å…‰, é–‹å¿ƒ, è‡ªç„¶å…‰ç·š, å¥½ç›¸è™•, æ¸…æ™°ç­‰æ‰€æœ‰æ­£é¢è©å½™
                { word: 'æ¸…æ™°', color: 'text-green-600' },
                { word: 'ç¬‘å®¹', color: 'text-green-600' },
                { word: 'è‡ªç„¶', color: 'text-green-600' },
                { word: 'é«˜åˆ†', color: 'text-green-600' },
                { word: 'è³ªæ„Ÿ', color: 'text-green-600' },
                { word: 'è‡ªä¿¡', color: 'text-green-600' },
                { word: 'å¸å¼•äºº', color: 'text-green-600' },
                { word: 'å°ˆæ¥­', color: 'text-green-600' },
                { word: 'é™½å…‰', color: 'text-green-600' },
                { word: 'é–‹å¿ƒ', color: 'text-green-600' },
                { word: 'å¥½ç›¸è™•', color: 'text-green-600' },
                { word: 'è‡ªç„¶å…‰ç·š', color: 'text-green-600' },
                { word: 'å…‰ç·šå……è¶³', color: 'text-green-600' },
                { word: 'æˆ¶å¤–', color: 'text-green-600' },
                { word: 'å¾®ç¬‘', color: 'text-green-600' },
                { word: 'æœ‰æ´»åŠ›', color: 'text-green-600' },
                { word: 'çœŸèª ', color: 'text-green-600' },
                { word: 'é¦è…†', color: 'text-green-600' },
                
                // Negative/Improvement (ç´…è‰²) - åŒ…å« åš´è‚…, å–®èª¿, å†·å†·, æ¨¡ç³Š, ä½åˆ†ç­‰æ‰€æœ‰è² é¢è©å½™
                { word: 'æ¨¡ç³Š', color: 'text-red-600' },
                { word: 'å–®èª¿', color: 'text-red-600' },
                { word: 'èƒŒæ™¯é›œäº‚', color: 'text-red-600' },
                { word: 'ä½åˆ†', color: 'text-red-600' },
                { word: 'å…‰ç·šä¸è¶³', color: 'text-red-600' },
                { word: 'è£å‰ª', color: 'text-red-600' },
                { word: 'åš´è‚…', color: 'text-red-600' },
                { word: 'å†·å†·', color: 'text-red-600' },
                { word: 'å†·æ·¡', color: 'text-red-600' },
                { word: 'é™°å½±', color: 'text-red-600' },
                { word: 'éæ›', color: 'text-red-600' },
                { word: 'åƒµç¡¬', color: 'text-red-600' },

                // Neutral/Context (é›è‰²)
                { word: 'å¤§é ­è²¼', color: 'text-indigo-600' },
                { word: 'èƒŒæ™¯', color: 'text-indigo-600' },
                { word: 'å…‰ç·š', color: 'text-indigo-600' },
                { word: 'å§¿å‹¢', color: 'text-indigo-600' },
                { word: 'ä¸»é¡Œ', color: 'text-indigo-600' },
            ];

            let highlightedText = text;

            // ç¢ºä¿é•·çš„é—œéµå­—å…ˆè¢«æ›¿æ›
            keywords.sort((a, b) => b.word.length - a.word.length);

            keywords.forEach(({ word, color }) => {
                // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼é€²è¡Œå…¨åŸŸæ›¿æ›ï¼Œç¢ºä¿åŒ¹é…åˆ°çš„è©èªè¢«å®Œå…¨åŒ…è£¹åœ¨ span æ¨™ç±¤ä¸­
                const regex = new RegExp(`(${word})`, 'g');
                highlightedText = highlightedText.replace(regex, `<span class="${color} font-bold">$1</span>`);
            });

            return highlightedText;
        }

        // --- 1. åˆå§‹åŒ–ç…§ç‰‡ä¸Šå‚³æ§½ ---
        function initializePhotoSlots() {
            photoContainer.innerHTML = '';
            for (let i = 0; i < maxPhotos; i++) {
                const slot = document.createElement('div');
                slot.className = 'photo-slot relative bg-gray-100 border-4 border-dashed border-gray-300 rounded-xl overflow-hidden cursor-pointer hover:border-indigo-400 transition group flex flex-col justify-center items-center p-2';
                slot.innerHTML = `
                    <input type="file" id="photo-input-${i}" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" data-index="${i}">
                    <div id="preview-${i}" class="w-full h-full flex justify-center items-center text-gray-500 group-hover:text-indigo-500 flex-col">
                        <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="text-sm">ç…§ç‰‡ ${i + 1}</span>
                    </div>
                    <div id="score-box-${i}" class="score-display absolute bottom-0 left-0 right-0 p-1 bg-white bg-opacity-80 backdrop-blur-sm text-center text-xl font-bold rounded-t-lg shadow-inner flex flex-col items-center justify-center">
                        <span class="text-gray-700">--</span>/100
                        <span class="text-sm mt-1 font-semibold text-gray-500" id="rating-text-${i}"></span>
                        <div id="optimization-link-${i}" class="mt-2"></div>
                    </div>
                `;
                photoContainer.appendChild(slot);
            }
            attachFileListeners();
        }

        // --- 2. æª”æ¡ˆç›£è½èˆ‡ Base64 è½‰æ› ---
        function attachFileListeners() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const base64Data = e.target.result.split(',')[1];
                            photoData[index] = { data: base64Data, mimeType: file.type };
                            
                            // é¡¯ç¤ºé è¦½åœ–
                            const previewDiv = document.getElementById(`preview-${index}`);
                            previewDiv.innerHTML = `<img src="${e.target.result}" alt="Photo Preview ${index + 1}" class="w-full h-full object-cover rounded-md">`;
                            
                            checkReady();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
        }

        // --- 3. æ€§åˆ¥é¸æ“‡è™•ç† ---
        document.querySelectorAll('.gender-select').forEach(button => {
            button.addEventListener('click', (event) => {
                // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active æ¨£å¼
                document.querySelectorAll('.gender-select').forEach(btn => {
                    btn.classList.remove('ring-4', 'ring-offset-2', 'ring-opacity-75');
                });
                
                // è¨­å®šç•¶å‰æŒ‰éˆ•çš„ active æ¨£å¼
                event.target.classList.add('ring-4', 'ring-offset-2', 'ring-opacity-75');

                selectedGender = event.target.dataset.gender;
                genderStatus.textContent = `å·²é¸æ“‡ï¼š${selectedGender === 'Female' ? 'å¥³ç”Ÿ' : 'ç”·ç”Ÿ'}`;
                genderStatus.classList.remove('text-red-500');
                genderStatus.classList.add('text-green-600');
                checkReady();
            });
        });

        // --- 4. æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å§‹è©•åˆ† ---
        function checkReady() {
            const hasPhotos = photoData.some(data => data !== null);
            startButton.disabled = !(selectedGender && hasPhotos);
        }

        // --- 5. æ¸…é™¤ç…§ç‰‡åŠŸèƒ½ ---
        clearButton.addEventListener('click', () => {
            photoData.fill(null);
            initializePhotoSlots(); // é‡ç¹ªæ‰€æœ‰æ§½ä½
            startButton.disabled = true;
            overallResult.classList.remove('visible');
            document.getElementById('overall-score-value').textContent = '--';
            document.getElementById('overall-feedback').textContent = 'å°šç„¡è©•ä¼°çµæœã€‚';
            errorMessage.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            genderStatus.textContent = selectedGender ? `å·²é¸æ“‡ï¼š${selectedGender === 'Female' ? 'å¥³ç”Ÿ' : 'ç”·ç”Ÿ'}` : 'è«‹å…ˆé¸æ“‡èº«ä»½';
            document.querySelectorAll('.gender-select').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-offset-2', 'ring-opacity-75');
            });
        });

        // --- 6. API å‘¼å« (é–‹å§‹è©•åˆ†) ---
        startButton.addEventListener('click', async () => {
            if (!selectedGender) {
                errorMessage.textContent = 'è«‹å…ˆé¸æ“‡æ‚¨çš„èº«ä»½ï¼';
                errorMessage.classList.remove('hidden');
                return;
            }

            const activePhotos = photoData.filter(data => data !== null);
            if (activePhotos.length === 0) {
                errorMessage.textContent = 'è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼';
                errorMessage.classList.remove('hidden');
                return;
            }

            // UI ç‹€æ…‹æ›´æ–°
            startButton.disabled = true;
            clearButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            overallResult.classList.remove('visible');
            
            // æ¸…é™¤èˆŠåˆ†æ•¸é¡¯ç¤ºå’Œæ¨™ç±¤
            for (let i = 0; i < maxPhotos; i++) {
                const scoreBox = document.getElementById(`score-box-${i}`);
                const ratingText = document.getElementById(`rating-text-${i}`);
                const optimizationLink = document.getElementById(`optimization-link-${i}`);

                if (scoreBox) {
                    scoreBox.querySelector('span').textContent = '--';
                    scoreBox.classList.remove('visible', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700', 'bg-orange-100', 'text-orange-700', 'bg-red-100', 'text-red-700');
                }
                if (ratingText) {
                    ratingText.textContent = '';
                    ratingText.className = 'text-sm mt-1 font-semibold'; // é‡ç½®æ¨£å¼
                }
                if (optimizationLink) {
                    optimizationLink.innerHTML = ''; // æ¸…é™¤å„ªåŒ–é€£çµ (é€™æ˜¯å¿…è¦çš„ï¼Œå³ä½¿åŠŸèƒ½å·²ç§»é™¤)
                }
            }


            const genderText = selectedGender === 'Female' ? 'å¥³æ€§' : 'ç”·æ€§';

            // æ§‹å»º API å…§å®¹
            const contents = [{
                role: "user",
                parts: [
                    { 
                        text: `You are an expert in dating app psychology and market trends, specifically providing advice for the Taiwanese market. Analyze the following ${activePhotos.length} images for a dating app profile. The user identifies as ${genderText} (Traditional Chinese: ${genderText}). 
                            For each image, provide a 'Main Photo Score' (out of 100) indicating how effective it would be as the primary profile picture. Then, provide an 'Overall Profile Score' (out of 100) based on all submitted images combined, considering variety, quality, and composition.
                            Your response MUST strictly be a JSON object conforming to the provided schema. All text in the 'feedback' field MUST be in Traditional Chinese.` 
                    }
                ]
            }];

            // åŠ å…¥åœ–ç‰‡ parts
            activePhotos.forEach(photo => {
                contents[0].parts.push({
                    inlineData: {
                        mimeType: photo.mimeType,
                        data: photo.data
                    }
                });
            });


            const payload = {
                contents: contents,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "overall_score": { "type": "INTEGER", "description": "äº¤å‹å¸‚å ´æ•´é«”è©•åˆ† (0-100)" },
                            "image_scores": {
                                "type": "ARRAY",
                                "description": "æ¯å€‹ç…§ç‰‡ä½œç‚ºå¤§é ­ç…§çš„å–®ç¨è©•åˆ† (0-100)",
                                "items": { "type": "INTEGER" }
                            },
                            "feedback": { "type": "STRING", "description": "çµ¦ç”¨æˆ¶çš„ç¶œåˆå»ºè­° (ç”¨ç¹é«”ä¸­æ–‡)" }
                        },
                        required: ["overall_score", "image_scores", "feedback"]
                    }
                },
                systemInstruction: {
                    parts: [{ text: "You are a professional dating profile photo evaluator. Always respond in Traditional Chinese JSON format." }]
                }
            };
            
            let resultJson;
            try {
                // å¯¦æ–½æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
                const maxRetries = 5;
                let delay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const rawText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (rawText) {
                            try {
                                resultJson = JSON.parse(rawText);
                                break; // æˆåŠŸè§£æï¼Œè·³å‡ºè¿´åœˆ
                            } catch (e) {
                                console.error("Failed to parse JSON response:", rawText);
                                throw new Error("API response format error.");
                            }
                        }
                    }

                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // æŒ‡æ•¸å¢åŠ å»¶é²
                    } else {
                        throw new Error("API call failed after multiple retries.");
                    }
                }
                
                if (resultJson) {
                    displayResults(resultJson, photoData.map(p => p !== null));
                } else {
                    throw new Error("æœªèƒ½å¾ AI ç²å¾—æœ‰æ•ˆè©•åˆ†çµæœã€‚");
                }

            } catch (error) {
                console.error("API Error:", error);
                errorMessage.textContent = `è©•åˆ†å¤±æ•—ï¼š${error.message || 'ç„¡æ³•é€£æ¥åˆ° AI æœå‹™ã€‚'}`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                startButton.disabled = false;
                clearButton.disabled = false;
            }
        });

        // --- 7. é¡¯ç¤ºçµæœ ---
        function displayResults(data, photoExistsMask) {
            const { overall_score, image_scores, feedback } = data;

            // é¡¯ç¤ºç¸½é«”åˆ†æ•¸å’Œå»ºè­°ï¼Œä½¿ç”¨ innerHTML ä¾†é¡¯ç¤ºå¸¶é¡è‰²çš„é—œéµå­—
            document.getElementById('overall-score-value').textContent = overall_score || '--';
            document.getElementById('overall-feedback').textContent = ''; // æ¸…é™¤èˆŠçš„æ–‡å­—å…§å®¹
            document.getElementById('overall-feedback').innerHTML = highlightKeywords(feedback);
            overallResult.classList.add('visible');

            // é¡¯ç¤ºå–®å¼µç…§ç‰‡åˆ†æ•¸å’Œæ–‡å­—è©•èª
            let scoreIndex = 0;
            for (let i = 0; i < maxPhotos; i++) {
                const scoreBox = document.getElementById(`score-box-${i}`);
                const ratingTextSpan = document.getElementById(`rating-text-${i}`);
                const optimizationLinkDiv = document.getElementById(`optimization-link-${i}`);
                
                // æ¯æ¬¡éƒ½æ¸…é™¤å„ªåŒ–é€£çµ (ç¢ºä¿ç¬¬ä¸€é …ä¿®æ”¹ç”Ÿæ•ˆ)
                optimizationLinkDiv.innerHTML = '';


                if (scoreBox && ratingTextSpan && photoExistsMask[i]) {
                    const score = image_scores[scoreIndex];
                    scoreBox.querySelector('span').textContent = score !== undefined ? score : '--';
                    
                    // ç§»é™¤èˆŠçš„é¡è‰²å’Œæ–‡å­—æ¨£å¼
                    scoreBox.classList.remove('bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700', 'bg-orange-100', 'text-orange-700', 'bg-red-100', 'text-red-700');
                    ratingTextSpan.className = 'text-sm mt-1 font-semibold'; // é‡ç½®æ¨£å¼

                    let textRating = '';
                    let textColorClass = '';
                    
                    // è©•ç´šæ¨™æº–ï¼š
                    // >= 80: éå¸¸å¥½ (ç¶ è‰²)
                    // >= 60: ä¸éŒ¯å–” (æ©™è‰²)
                    // < 60: ä¸æ¨è–¦ (ç´…è‰²)
                    if (score >= 80) {
                        textRating = 'â­ï¸ éå¸¸å¥½ï¼';
                        textColorClass = 'text-green-600';
                        scoreBox.classList.add('bg-green-100', 'text-green-700');
                    } else if (score >= 60) {
                        textRating = 'ğŸ‘ ä¸éŒ¯å–”';
                        textColorClass = 'text-orange-600'; // ä½¿ç”¨æ©™è‰²
                        scoreBox.classList.add('bg-orange-100', 'text-orange-700');
                    } else {
                        textRating = 'ğŸ‘ ä¸æ¨è–¦';
                        textColorClass = 'text-red-600';
                        scoreBox.classList.add('bg-red-100', 'text-red-700');
                        
                        // å·²ç§»é™¤å„ªåŒ–é€£çµç”Ÿæˆé‚è¼¯ (ç¬¦åˆæ‚¨çš„è¦æ±‚)
                    }

                    ratingTextSpan.textContent = textRating;
                    ratingTextSpan.classList.add(textColorClass);
                    
                    scoreBox.classList.add('visible');
                    scoreIndex++;
                } else if (scoreBox) {
                    // å°æ–¼æœªä¸Šå‚³çš„æ§½ä½ï¼Œç¢ºä¿åˆ†æ•¸éš±è—ä¸”æ²’æœ‰é¡è‰²
                    scoreBox.classList.remove('visible', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700', 'bg-orange-100', 'text-orange-700', 'bg-red-100', 'text-red-700');
                    if (ratingTextSpan) {
                        ratingTextSpan.textContent = '';
                        ratingTextSpan.className = 'text-sm mt-1 font-semibold';
                    }
                }
            }
        }

        // --- 8. é¦–æ¬¡è¼‰å…¥ ---
        document.addEventListener('DOMContentLoaded', () => {
            initializePhotoSlots();
            overallResult.classList.add('hidden'); // åˆå§‹éš±è—çµæœå€å¡Š
            // ä½¿ç”¨ setTimeout ç¢ºä¿ Tailwind éæ¸¡æ•ˆæœåœ¨ç¬¬ä¸€æ¬¡é¡¯ç¤ºæ™‚ç”Ÿæ•ˆ
            setTimeout(() => overallResult.classList.remove('hidden'), 50);
        });
    </script>
</body>
</html>